---
title: "CUBAN MIGRATION ANALYSIS"
author: "Gabriel Hernandez"
date: "2024-03-21"
output: html_document
---


```{r install packages}
install.packages('tidyverse')
install.packages('tidycensus')
install.packages('sf')
install.packages('stringr')
install.packages('tigris')
install.packages('patchwork')
install.packages('kableExtra')
install.packages('ggforce') #built above ggplot 2
install.packages('osmdata')
install.packages("mapview")
install.packages("flexdashboard") #make dashboards
#install.packages("scales") #ggplot 2 scales and legend grammar
install.packages("shiny")
library(tidyverse)
library(patchwork)
library(mapview)
library(tidycensus)
library(sf)
library(kableExtra)
library(osmdata)
library(ggforce)
library(tigris)
library(flexdashboard)
#library(scales)
library(shiny)
library(stringr)


options(scipen=999)
options(tigris_class = "sf")
options(tigris_cache_dir= TRUE)

source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

#Load API KEY
census_api_key("3aedcfd189958d66a813a29a4b33580e78657644", overwrite = TRUE)
#Set CRS
crs='EPSG:3857'


```
```{r}



```


```{r pressure, echo=FALSE}
# vars for 2009 and 2022 for change over time comparison

acs_variable_list.2009 <- load_variables(2009, #year
                                         "acs5", #five year ACS estimates
                                         cache = TRUE)

acs09_vars <- c("B06003_013E", #Foreign Born - PLACE OF BIRTH BY SEX IN THE UNITED STATES
              "B05002_013E", #Estimate!!Total!!Foreign born - PLACE OF BIRTH BY CITIZENSHIP STATUS
              "B05007_039E", #Estimate!!Total!!Latin America!!Caribbean!!- Entered before 1980
              "B25002_003E", #stimate!!Total!!Vacant OCCUPANCY STATUS
              "B09016_002E", #Estimate!!Total!!In households - HOUSEHOLD TYPE (INCLUDING LIVING ALONE) BY RELATIONSHIP
              "B19013_001E", #Estimate!!Median household income in the past 12 months (in 2009 inflation-adjusted dollars)
              "B19037A_053E", #Estimate!!Total!!Householder 65 years and over
              "B06012_002E", #Total!!Below 100 percent of the poverty level
              "B25071_001E", #Median gross rent as a percentage of household income
              "B25035_001E", #Median year structure built
              "B19057_001E", #Total - PUBLIC ASSISTANCE INCOME IN THE PAST 12 MONTHS FOR HOUSEHOLDS
              "B25001_001E", #Total HOUSING UNITS
              "B05006_127E", #Total!!Americas!!Latin America!!Caribbean!!Cuba
              "B25077_001E") #med values

acs22load <- load_variables(2022, "acs5", cache = TRUE)
acs22_vars <-c("B06012PR_002E", #Tot Below 100 percent of the poverty level
               "B25002_003E", #TotalVacant
               "B21004_001E", #Median income in the past 12 months (in 2022 inflation-adjusted dollars
               "B09021_023E", #65 years and over Lives alone
               "B25136_001E", #Total Housing Units
               "B25071_001E", #Median gross rent as a percentage of household income
               "B05006_143E", #Total:!!Americas:!!Latin America:!!Caribbean:!!Cuba
               "B19057_002E", #Total:!!With public assistance income
               "B25035_001E", #Median year structure built
               "B25077_001E" #med values
       )



```

In order to perform the analysis I will have to use tidycensus and tigris to get not only dataframes but geometries associated with the counties, cities, and census tracts that I will be using in my final visualizzation. The first calls are to get the data we need on foreign-born cubans at the county level in order to identify, outside of florida, what are the counties with the current highest concentration of foreign-born Cubans. I will also use tigris to get an sf object of "places" in the united states. The goal is to identify counties of interest and create an sf object from intersecting those counties and the places object of all cities in the United states.

Furthermore, at the end of the county-level analysis, a call will be made to tigris to get the census tracts for the counties of interest in order to join them to the dataframe with the change-over-time values. THis will be for the main visualization: an interactive map that displays first the location of counties of interest and then upon zooming in, the boundaries of the places that they are in and the census tract level data displaying where in the counties the cuban communities are relative to the city boundaries. (relate this to theory about settlement patterns of immigrants). 

```{r}

#get variables in core_based_statistical areas across USA

USA_allcba <- get_acs(geography = "metropolitan statistical area/micropolitan statistical area",
                             year = 2022, 
                             variables = acs22_vars, 
                             geometry = TRUE, 
                             output = "wide") 
```
The call above generates data and geometries for metro and micro statistical Areas in the United States. Below we wrangle the data to see where the highest concentrations of Cubans int he US are. 

```{r}
USA_allcba <- USA_allcba %>%
         rename(total_below_pov=B06012PR_002E,
         tot_vacant22 = B25002_003E,
         med_inc22 = B21004_001E,
         up65_alone22 = B09021_023E,
         tot_housingunits22 =B25136_001E,
         gross_v_inc_perc22 = B25071_001E,
         tot_fb_cuba22 = B05006_143E,
         tot_pa_inc22 = B19057_002E,
         med_yb22 = B25035_001E,
         med_values22 = B25077_001E)%>%
  mutate(vacpct22 = (tot_vacant22/tot_housingunits22)) %>%
  st_as_sf(crs = crs)

view(USA_allcba)


```
The chunk below will isolate micro and metro areas in the cba dataset to be able to arrange them in a way that we can create a table with the top concentrations of foreign-born cubans in both micro and metro areas. 

```{r}

# Assuming your dataframe is named df and the column of interest is 'Name'
USA_micros <- USA_allcba %>%
              filter(grepl("Micro", NAME, ignore.case = TRUE)) %>%
              select(NAME, GEOID,tot_housingunits22,gross_v_inc_perc22,tot_fb_cuba22,med_yb22, vacpct22) %>%
              filter(tot_fb_cuba22 >= 100)%>%
              arrange(desc(tot_fb_cuba22))

USA_metros <- USA_allcba %>%
              filter(grepl("Metro", NAME, ignore.case=TRUE)) %>%
              select(NAME, GEOID,tot_housingunits22,gross_v_inc_perc22,tot_fb_cuba22,med_yb22, vacpct22) %>%
              filter(tot_fb_cuba22 >= 1000)%>%
              arrange(desc(tot_fb_cuba22))

view(USA_metros)
view(USA_micros)

```

We all know that there is a long-standing pattern of settling in Florida for the Cuban diasporic community. The chunk below removes areas in Florida in both the Metro and Micro places in order to visualize settlements outside of the geographies that we expect to see cubans .i.e Florida.
We provide the results as tables of micro and metro areas. We will also make a table of just Florida places to analyze that story deeper. 

Furthermore we observe correlation plots between the count of cubans and the average year of structures, gross rent to income percentage, and the total number of housing units and vacancy rates. 


```{r}

noFL_micros <- USA_micros %>%
              filter(!grepl("FL M", NAME, ignore.case = TRUE)) 
            

noFL_metros <-USA_metros %>%
              filter(!grepl("FL M" , NAME, ignore.case= TRUE))

fl_micros <- USA_micros %>%
             filter(grepl("FL M", NAME, ignore.case = TRUE)) 
            

fl_metros <-USA_metros %>%
            filter(grepl("FL M" , NAME, ignore.case= TRUE))
            

view(noFL_metros)
view(noFL_micros)
view(fl_micros)
view(fl_metros)
```

```{r}
#use this chunk to introduce correlation plots between count of fb cubans and the other variables
# also show a plot of vacancies to gross rent inc
#show total number of units to gross rent income
#do this for both micro and metro, for both fl and non florida
#If we were to tell cubans where to move to based on 2002 gross rent to income, vacancy rates, and total housing units available, and incomes?
# a correlation matrix with values in the squares would be best generated rather than multiple plots. we can facet them to compare correlations 
```

The analysis below is to take the first steps to generate the final interactive visualization, which will show the census tract level value of foreign born cubans over time. It will also generate the change over time county map that shows where there have been increases and decreases of cubans.

The goal is to get the change over time as a percentage and then tie it to counties. We have to ask tigris to get those geometries, create an object with them, and then merge it to the final change over time dataset created below. That will yield an important visualization of the project.



```{r}

USA_2009 <- get_acs(geography = "county",
                             year = 2009, 
                             variables = acs09_vars,
                             geometry = TRUE, 
                             output = "wide") 
USA_2009 <- USA_2009 %>%
          rename(
          fb_placebysex.2009 = B06003_013E,
          totalfb_placebycitizenshipstatus.2009 = B05002_013E,
          total_carib_1980.2009 = B05007_039E,
          total_vacancy_O_status.2009 = B25002_003E,
          total_householdtype_relationship.09 = B09016_002E,
          med_hh_inc.09 = B19013_001E,
          hh_65up.09 = B19037A_053E,
          Total_b_100pov.09 = B06012_002E,
          gross_v_income_percentage.09 = B25071_001E,
          med_built_year.09 = B25035_001E,
          tot_publicass_inc.09 = B19057_001E,
          tot_housingunits.09 = B25001_001E,
          cub_fb_total09 = B05006_127E,
          med_houseval09 = B25077_001E
          )%>%
          mutate(vacancyPct.2009 = total_vacancy_O_status.2009/tot_housingunits.09) %>% # Get Vacanct Rate
          st_as_sf(crs = crs)

USA_2022 <- get_acs(geography = "county",
                             year = 2022, 
                             variables = acs22_vars, 
                             geometry = TRUE, 
                             output = "wide") 
USA_2022 <- USA_2022 %>%
         rename(
         tot_below100pov22 = B06012PR_002E,
         tot_vacant22 = B25002_003E,
         med_inc22 = B21004_001E,
         up65_alone22 = B09021_023E,
         tot_housingunits22 =B25136_001E,
         gross_v_inc_perc22 = B25071_001E,
         tot_fb_cuba22 = B05006_143E,
         tot_pa_inc22 = B19057_002E,
         med_yb22 = B25035_001E,
         med_values22 = B25077_001E)%>%
  mutate(vacpct22 = (tot_vacant22/tot_housingunits22)) %>%
  st_as_sf(crs = crs)

 


```

```{r}

#Merge the dataframes

USA0922_df <- st_drop_geometry(USA_2022,USA_2009)%>%
         left_join(USA_2009 , USA_2022, by= c("GEOID"))%>%
         mutate(change_vac_pct = vacpct22 - vacancyPct.2009,
           change_med_inc = med_inc22 - med_hh_inc.09,
           change_med_values = med_values22 - med_houseval09,
           change_cuba_fb = tot_fb_cuba22 - cub_fb_total09,
           change_pct_below100pov = tot_below100pov22 - Total_b_100pov.09)
#===========================================================
#This does not work, returns multiples of the same county
#===========================================================
#sf.ACS0922 <-st_join(USA_2009,USA_2022)%>%
   # mutate(change_vac_pct = vacpct22 - vacancyPct.2009,
   #      change_med_inc = med_inc22 - med_hh_inc.09,
    #     change_med_values = med_values22 - med_houseval09,
    #     change_cuba_fb = tot_fb_cuba22 - cub_fb_total09, 
    #      change_pct_below100pov = tot_below100pov22 - Total_b_100pov.09)


#Filter to get the largest and lowest decreases. using 500 is an arbitrary number. With more feedback and domain knowledge I could choose another
USA0922_df_filtered_decrease <- USA0922_df %>%
              filter(change_cuba_fb < -500)%>%
              select(NAME.x, GEOID, geometry,med_inc22,up65_alone22, tot_housingunits22, gross_v_inc_perc22,                                 tot_pa_inc22,med_values22, vacpct22, change_med_values, change_med_inc,                         change_vac_pct)

USA0922_df_filtered_increase <- USA0922_df %>% 
       filter(change_cuba_fb > 500) %>%
       select(NAME.x, GEOID, geometry, med_inc22,up65_alone22, tot_housingunits22, gross_v_inc_perc22,                                 tot_pa_inc22,med_values22, vacpct22, change_med_values, change_med_inc,                         change_vac_pct)
  
#Combine the two dfs because it is the object that will be used to create the dictionary for the get acs call

change_fbcuban0922<- rbind(USA0922_df_filtered_decrease, USA0922_df_filtered_increase)

var_list_final<- unique(change_fbcuban0922)

#use this ^^^^^ to create model for analysis




```



Upon analyzing the counties, choose filters to get the most increasing and decreasing populations. Get the ID of each of these counties in a way so we can intersect the USA_allcba object to get the geometries of only the metro and micro areas that are within the chosen counties.

We also have to iterate those counties over a function that gets all the census tract level data for the county. Once we have these object, the next step will be to figure out how to classify the data so it can make nice visuals!!!

Will spend this weekend doing literature review to be able to supplement the observations. 


```{r}
#=============================
#Create function that creates a dictionary that has the state county combination to ask for the tract level data
#===============================

split_county_state <- function(name) {
  # Split the string on the comma to separate county and state
  parts <- str_split(name, pattern = ",", n = 2, simplify = TRUE)
  county <- trimws(parts[1])
  state <- trimws(parts[2])

  return(list(county = county, state = state))
}

clean_county_name <- function(county_name) {
  # Remove 'County' from the end of the string and any leading/trailing spaces
  cleaned_name <- sub("County$", "", county_name)
  cleaned_name <- trimws(cleaned_name)
  return(cleaned_name)
}

#to visualize per state grouping, do I need to use tigris to get the geometries for each state then merge it with a group by state function?
```


```{r}

change_fbcuban0922_split <- change_fbcuban0922 %>%
  mutate(
    split_data = map(NAME.x, split_county_state),
    County = map_chr(split_data, "county"),
    State = map_chr(split_data, "state")
  ) %>%
  select(-split_data)%>%
  mutate(cleaned_County = sapply(County, clean_county_name))# Remove the list column after extracting components

```


```{r}
iterate_county22 <- function(df) {
  # List to store the results
  results_list <- list()

  # Loop over each row of the dataframe
  for (i in 1:nrow(df)) {
    # Extract county and state from the current row
    County <- df$cleaned_County[i]
    State <- df$State[i]
    
    # Try to fetch ACS data, handling errors
    acs_data <- tryCatch({
      get_acs(
        geography = "tract",  # Make sure geography is correctly specified
        variables = "B05006_143E",  # Example variable: Total Population
        state = State,
        county = County,
        year = 2022,
        survey = "acs5",
        geometry = TRUE
      )
    }, error = function(e) {
      message("Failed for ", County, ", ", State, ": ", e$message)
      NULL  # Return NULL on failure
    })
    
    # Append the fetched data to the list, if not NULL
    if (!is.null(acs_data)) {
      results_list[[length(results_list) + 1]] <- acs_data
    }
  }

  # Combine all the results into one data frame
  final_data <- bind_rows(results_list)
  return(final_data)
}

iterate_county09 <- function(df) {
  # List to store the results
  results_list <- list()

  # Loop over each row of the dataframe
  for (i in 1:nrow(df)) {
    # Extract county and state from the current row
    County <- df$cleaned_County[i]
    State <- df$State[i]
    
    # Try to fetch ACS data, handling errors
    acs_data <- tryCatch({
      get_acs(
        geography = "tract",  # Make sure geography is correctly specified
        variables = "B05006_127E",  # Example variable: Total Population
        state = State,
        county = County,
        year = 2009,
        survey = "acs5",
        geometry = TRUE
      )
    }, error = function(e) {
      message("Failed for ", County, ", ", State, ": ", e$message)
      NULL  # Return NULL on failure
    })
    
    # Append the fetched data to the list, if not NULL
    if (!is.null(acs_data)) {
      results_list[[length(results_list) + 1]] <- acs_data
    }
  }

  # Combine all the results into one data frame
  final_data <- bind_rows(results_list)
  return(final_data)
}

```

```{r , results='hide'}

final_acs09_data <- iterate_county09(change_fbcuban0922_split)
final_acs22_data <- iterate_county22(change_fbcuban0922_split)
```

```{r}

#wrangle the data a bit to get the change over time at the census tract level
final_acs09_data<-final_acs09_data %>%
                  rename(cub_fb_total09 = estimate)

final_acs22_data<- final_acs22_data %>%
                  rename(tot_fb_cuba22 = estimate)

final_viz_change <- st_drop_geometry(final_acs09_data) %>%
  select(GEOID, cub_fb_total09) %>%  # Select only the columns needed for computing change
  left_join(final_acs22_data, by = "GEOID") %>%
  mutate(change_cuba_fb = tot_fb_cuba22 - cub_fb_total09)

#dropNA values in change
final_viz_change_droppedNA <- final_viz_change[!is.na(final_viz_change$change_cuba_fb), ]

final_viz_change_droppedNA<- final_viz_change_droppedNA%>%
                             st_as_sf(sf_column_name='geometry')
```


```{r}
#we are going to intercect all metro and micro areas with the selected counties object 'change_fbcuban0922'

metro_micro_boundaries_final <-USA_allcba%>%
                     st_as_sf(sf_column_name='geometry')%>%
                     st_intersection(change_fbcuban0922)




```
```{r}
# Install (if necessary) and load the tmap package
if (!requireNamespace("tmap", quietly = TRUE)) {
    install.packages("tmap")
}
library(tmap)

tmap_options(check.and.fix = TRUE)

# Set tmap mode to interactive viewing
tmap_mode("view")

# Create the map
tm <- 
      tm_shape(final_viz_change_droppedNA) +  # Adds the 'final' object
      tm_polygons("change_cuba_fb", title = "Change in Count of Foreign Born Cubans", 
                  palette = "-RdYlBu",  # Color palette
                  style = "quantile",  # Classification style
                  border.col = "white",  # Border color for polygons in 'final'
                  border.alpha = 0.5)  # Border transparency

# Print the map
tm

#tm_tip(c("change_cuba_fb", "other_attribute1", "other_attribute2"), labels = c("Change FB:", "Attribute 1:", "Attribute 2:"))  # Tooltips showing attributes

```


```{r}

```


The goals for the next chunks of code:

--make sure to reindex when the arrangement takes place so you can do a filter by first 25 positions.
----the purpose would be to do a get acs call for the census tract level data on fb cuban population, and change over time.
-----we also want to be able to ask of a query: if an MSA boundary is within any of these counties, create an object that contains only those MSAs
-----------------the purpose would be for the final interactive t map which will include the census tract visualizations for the top 25 counties (negative and positive flows combined) and the borders of the MSAs to visualize if the community exists inside or outside of a metropolitan area. 

-I think the county stuff does not need to be visualized independently. Instead we will create a table that displays the county name, state, change over time of cuban population and the quantity of the population

-We need to fix the line graph, make it prettier
-we need the bar plot to also look better for the net migration
-the encounters table is solid, maybe just make it prettier. 


Notes
-- (purr) map_dfr() iterates over an input and applies it to a function or process defined by the user, then row-binds the result into a single data frame.
----use map_dfr after creating a names(vector) in which the vecto=whatever identifies the counties that we are interested in (can it be geoid) and use this as the model:
------------------
years <- 2010:2019
names(years) <- years

college_by_year <- map_dfr(years, ~{
  get_acs(
    geography = "county",
    variables = college_vars,
    state = "CO",
    summary_var = "B15002_001",
    survey = "acs1",
    year = .x
  )
}, .id = "year")

The .id argument, which is optional but used here, creates a new column in the output data frame that contains values equivalent to the names of the input object, which in this case is years. By setting .id = "year", we tell map_dfr() to name the new column that will contain these values year.
------------------
---The geography we need:  "metropolitan statistical area/micropolitan statistical area" to just make that tmap then clip off the geographies of the selected counties
-------A metropolitan or micropolitan statistical area contains a core area with a substantial population nucleus,
as well as adjacent communities having a high degree of economic and social integration with that core.
Core Based Statistical Area (CBSA) term became effective in 2000 and refers collectively to metropolitan
and micropolitan statistical areas
-------Each metropolitan statistical area must have one urbanized area of 50,000 or more inhabitants. Each
micropolitan statistical area must have one urban cluster of 10,000 to 49,999 inhabitants

----core_based_statistical_areas()

